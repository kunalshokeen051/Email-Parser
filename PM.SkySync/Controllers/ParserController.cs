using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using Newtonsoft.Json.Schema;
using OpenAI_API.Chat;
using OpenAI_API.Models;
using System.Text;

[ApiController]
[Route("/api")]
public class YourApiController : Controller
{
    private readonly IHttpClientFactory _clientFactory;

    public YourApiController(IHttpClientFactory clientFactory)
    {
        _clientFactory = clientFactory;
    }

    [HttpGet]
    [Route("test")]
    public async Task<IActionResult> ParseEmailContent(String Email)
    {

        /*Email = "Ticket\r\n\r\nHi Mishti, thank you for booking with us. We wish you a pleasant journey!\r\n\r\nBooking Confirmed\r\nDelhi - Bangalore\r\nRound trip • Sat, 30 September\r\nBooking ID: NF2S2W1HRLCUPK8A0055, (Booked on 10 September 2023)\r\n\r\n\r\nBarcode(s) for your journey Delhi-Bangalore on IndiGo\r\nMishti Ghosal\r\n\r\nBarcode(s) for your journey Bangalore-Delhi on AIR INDIA\r\nMishti Ghosal\r\n\r\n\r\nWeb Check-in\r\nManage Booking\r\n\r\nBOOKING DETAILS\r\nDelhi - Bangalore\r\nSat, 30 Sep 2023 • Non stop • 2h 45m duration\r\n\r\nIndiGo\r\n6E-2403\r\nPNR\r\nF28BXH\r\nDelhi\r\nDEL 07:05 hrs\r\nSat, 30 Sep\r\nIndira Gandhi International Airport Terminal 2\r\n\r\n2h 45m\r\nBangalore\r\n09:50 hrs BLR\r\nSat, 30 Sep\r\nBengaluru International Airport Terminal 1\r\n\r\nFLEXI PLUS\r\n\r\nEconomy\r\n\r\nRegular Fare\r\n\r\n15 Kgs (1 piece only)* check-in\r\n\r\n7 Kgs (1 piece only)* cabin\r\n*Baggage allowance shown above is per passenger\r\nTRAVELLER\r\nSEAT\r\nMEAL\r\nMS. MISHTI GHOSAL Adult\r\nF28BXH\r\n4D\r\nVegan meal\r\nBangalore - Delhi\r\nMon, 02 Oct 2023 • Non stop • 2h 50m duration\r\n\r\nAIR INDIA\r\nAI-503\r\nPNR\r\n6URFE3\r\nBangalore\r\nBLR 17:15 hrs\r\nMon, 02 Oct\r\nBengaluru International Airport Terminal 2\r\n\r\n2h 50m\r\nDelhi\r\n20:05 hrs DEL\r\nMon, 02 Oct\r\nIndira Gandhi International Airport Terminal 3\r\n\r\nFlex\r\n\r\nEconomy\r\n\r\nRegular Fare\r\n\r\n25 Kgs* check-in\r\n\r\n8 Kgs* cabin\r\n*Baggage allowance shown above is per passenger\r\nTRAVELLER\r\nSEAT\r\nMEAL\r\nMS. MISHTI GHOSAL Adult\r\n098-0989053406768\r\n26D\r\n\r\nPAYMENT INFORMATION\r\n\r\nTotal Price\r\n₹ 14691\r\nPaid by ICICI Bank\r\n₹ 14691\r\nYour invoice will be available after your travel on My Trips\r\nYou saved ₹ 75 with MMTSUPER coupon\r\n\r\nDIGI YATRA\r\n\r\nAvoid Long Queues at the Airport with DigiYatra\r\nUse DigiYatra — the Ministry of Civil Aviation’s mobile app to enjoy a hassle-free airport experience, for your upcoming flight. It enables you to activate face scan for check-in at the airport with 2 easy steps:\r\nStep 1: Pre-verifying your identity using Aadhaar Card details\r\nStep 2: Updating your upcoming flight’s boarding pass\r\nKnow More\r\n\r\n\r\nIMPORTANT INFORMATION\r\n\r\nFor a convenient travel, follow these guidelines\r\n•\r\nCheck-in Time : Passenger to report 2 hours before departure. Check-in procedure and baggage drop will close 1 hour before departure.\r\n•\r\nDGCA passenger charter : Please refer to passenger charter by clicking Here\r\n•\r\nCheck travel guidelines and baggage information below: : Carry no more than 1 check-in baggage and 1 hand baggage per passenger. If violated, airline may levy extra charges.Wearing a mask/face cover is no longer mandatory. However, all travellers are advised to do so as a precautionary measure.\r\n•\r\nValid ID proof needed : Carry a valid photo identification proof (Driver Licence, Aadhar Card, Pan Card or any other Government recognised photo identification)\r\n•\r\nPlease do not share your personal banking and security details like passwords, CVV, etc. with any third person or party claiming to represent MakeMyTrip. For any query, please reach out to MakeMyTrip on our official customer care number.\r\n\r\nCHANGE IN PLANS?\r\n\r\nDelhi - Bangalore\r\nCancellation Charges\r\nFor Adult\r\n4 days to 365 days before departure\r\nBefore 26 Sep 2023, 07:05 hrs\r\n₹800 /Traveller\r\n3 hours to 4 days before departure\r\nBefore 30 Sep 2023, 04:05 hrs\r\n₹3800 /Traveller\r\n0 hour to 3 hours before departure\r\nBefore 30 Sep 2023, 07:05 hrs\r\nNon Refundable\r\nCancel Flight\r\nDate Change Charges\r\nFor Adult\r\n4 days to 365 days before departure\r\nBefore 26 Sep 2023, 07:05 hrs\r\nFree Date Change\r\n3 hours to 4 days before departure\r\nBefore 30 Sep 2023, 04:05 hrs\r\n₹3550 /Traveller\r\n0 hour to 3 hours before departure\r\nBefore 30 Sep 2023, 07:05 hrs\r\nNon Changeable\r\nChange Date\r\n\r\nBangalore - Delhi\r\nCancellation Charges\r\nFor Adult\r\n2 hours to 365 days before departure\r\nBefore 02 Oct 2023, 15:15 hrs\r\n₹300 /Traveller\r\n0 hour to 2 hours before departure\r\nBefore 02 Oct 2023, 17:15 hrs\r\nNon Refundable\r\nCancel Flight\r\nDate Change Charges\r\nFor Adult\r\n2 hours to 365 days before departure\r\nBefore 02 Oct 2023, 15:15 hrs\r\nFree Date Change\r\n0 hour to 2 hours before departure\r\nBefore 02 Oct 2023, 17:15 hrs\r\nNon Changeable\r\nChange Date\r\nAll charges above are per traveller and per sector in INR\r\n\r\nSUBMIT A REFUND REQUEST\r\n\r\nPlease let us know if you would like us to contact the airline for your refund. Our agents will initiate the process and this might take up to 30 days. Choose the reason for your refund request:\r\nI cancelled directly with the airline\r\n\r\nMy flight was cancelled/delayed\r\n\r\n\r\nCONTACT US\r\n\r\n\r\nMakeMyTrip Support:\r\n\r\n+91124 4628747 / +91124 5045105 (India Number)\r\n\r\nIndiGo Support:\r\n\r\n0124-6173838, 0124-4973838\r\n\r\nAIR INDIA Support:\r\n\r\n18602331407\r\n\r\n\r\n\r\n\r\n\r\n\r\nNote: Please do not reply to this e-mail. This was sent from an automated mail service that cannot accept incoming e-mails.";*/



        try
        {
            var api_key = "";
            var api = new OpenAI_API.OpenAIAPI(api_key);
            /* var chat = api.Chat.CreateConversation();
             chat.Model = Model.GPT4_Turbo;
             chat.RequestParameters.Temperature = 0;*/


            ChatRequest chatRequest = new ChatRequest()
            {
                Model = Model.ChatGPTTurbo_1106,
                Temperature = 0.0,
                MaxTokens = 500,
                ResponseFormat = ChatRequest.ResponseFormats.JsonObject,
                Messages = new ChatMessage[] {
                                new ChatMessage(ChatMessageRole.System, "you are a email parsing system, that parse the email according to the JSON schema provided, and fill the json object with data. if not a travelling email, return empty json object"),

                                /*new ChatMessage(ChatMessageRole.User, "This is the json schema, \"{\\n  \\\"$schema\\\": \\\"http://json-schema.org/draft-07/schema#\\\",\\n  \\\"type\\\": \\\"object\\\",\\n  \\\"properties\\\": {\\n    \\\"booking_id\\\": { \\\"type\\\": \\\"string\\\" },\\n    \\\"booking_date\\\": { \\\"type\\\": \\\"string\\\" },\\n    \\\"passenger_name\\\": { \\\"type\\\": \\\"string\\\" },\\n    \\\"flights\\\": {\\n      \\\"type\\\": \\\"array\\\",\\n      \\\"items\\\": {\\n        \\\"type\\\": \\\"object\\\",\\n        \\\"properties\\\": {\\n          \\\"from\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"to\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"date\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"flight_number\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"departure_time\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"departure_airport\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"arrival_time\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"arrival_airport\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"duration\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"seat_type\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"fare_type\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"baggage_allowance\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"meal_preference\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"e_ticket_no\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"barcode\\\": { \\\"type\\\": \\\"string\\\" }\\n        },\\n        \\\"required\\\": [\\n          \\\"from\\\",\\n          \\\"to\\\",\\n          \\\"date\\\",\\n          \\\"flight_number\\\",\\n          \\\"departure_time\\\",\\n          \\\"departure_airport\\\",\\n          \\\"arrival_time\\\",\\n          \\\"arrival_airport\\\",\\n          \\\"duration\\\",\\n          \\\"seat_type\\\",\\n          \\\"fare_type\\\",\\n          \\\"baggage_allowance\\\",\\n          \\\"e_ticket_no\\\",\\n          \\\"barcode\\\"\\n        ]\\n      }\\n    },\\n    \\\"payment_details\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"total_price\\\": { \\\"type\\\": \\\"string\\\" },\\n        \\\"paid_by\\\": { \\\"type\\\": \\\"string\\\" },\\n        \\\"amount_saved\\\": { \\\"type\\\": \\\"string\\\" }\\n      },\\n      \\\"required\\\": [\\\"total_price\\\", \\\"paid_by\\\", \\\"amount_saved\\\"]\\n    },\\n    \\\"additional_information\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"web_check_in\\\": { \\\"type\\\": \\\"string\\\" },\\n        \\\"manage_booking\\\": { \\\"type\\\": \\\"string\\\" },\\n        \\\"digi_yatra\\\": { \\\"type\\\": \\\"string\\\" }\\n      },\\n      \\\"required\\\": [\\\"web_check_in\\\", \\\"manage_booking\\\", \\\"digi_yatra\\\"]\\n    },\\n    \\\"important_information\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"check_in_time\\\": { \\\"type\\\": \\\"string\\\" },\\n        \\\"valid_id_proof\\\": { \\\"type\\\": \\\"string\\\" }\\n      },\\n      \\\"required\\\": [\\\"check_in_time\\\", \\\"valid_id_proof\\\"]\\n    },\\n    \\\"change_in_plans\\\": {\\n      \\\"type\\\": \\\"array\\\",\\n      \\\"items\\\": {\\n        \\\"type\\\": \\\"object\\\",\\n        \\\"properties\\\": {\\n          \\\"from\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"cancellation_charges\\\": {\\n            \\\"type\\\": \\\"object\\\",\\n            \\\"properties\\\": {\\n              \\\"4_days_to_365_days_before_departure\\\": { \\\"type\\\": \\\"string\\\" },\\n              \\\"3_hours_to_4_days_before_departure\\\": { \\\"type\\\": \\\"string\\\" },\\n              \\\"0_hour_to_3_hours_before_departure\\\": { \\\"type\\\": \\\"string\\\" }\\n            }\\n          },\\n          \\\"date_change_charges\\\": {\\n            \\\"type\\\": \\\"object\\\",\\n            \\\"properties\\\": {\\n              \\\"4_days_to_365_days_before_departure\\\": { \\\"type\\\": \\\"string\\\" },\\n              \\\"3_hours_to_4_days_before_departure\\\": { \\\"type\\\": \\\"string\\\" },\\n              \\\"0_hour_to_3_hours_before_departure\\\": { \\\"type\\\": \\\"string\\\" }\\n            }\\n          }\\n        },\\n        \\\"required\\\": [\\\"from\\\", \\\"cancellation_charges\\\", \\\"date_change_charges\\\"]\\n      }\\n    },\\n    \\\"refund_request_contacts\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"MakeMyTrip\\\": { \\\"type\\\": \\\"string\\\" },\\n        \\\"IndiGo\\\": { \\\"type\\\": \\\"string\\\" },\\n        \\\"AIR INDIA\\\": { \\\"type\\\": \\\"string\\\" }\\n      },\\n      \\\"required\\\": [\\\"MakeMyTrip\\\", \\\"IndiGo\\\", \\\"AIR INDIA\\\"]\\n    }\\n  },\\n  \\\"required\\\": [\\n    \\\"booking_id\\\",\\n    \\\"booking_date\\\",\\n    \\\"passenger_name\\\",\\n    \\\"flights\\\",\\n    \\\"payment_details\\\",\\n    \\\"additional_information\\\",\\n    \\\"important_information\\\",\\n    \\\"change_in_plans\\\",\\n    \\\"refund_request_contacts\\\"\\n  ]\\n}\""),*/

                                new ChatMessage(ChatMessageRole.User, "This is the json schema, \"{\\n  \\\"$schema\\\": \\\"http://json-schema.org/draft-07/schema#\\\",\\n  \\\"type\\\": \\\"object\\\",\\n  \\\"properties\\\": {\\n    \\\"booking_id\\\": { \\\"type\\\": \\\"string\\\" },\\n    \\\"booking_date\\\": { \\\"type\\\": \\\"string\\\" },\\n    \\\"passenger_name\\\": { \\\"type\\\": \\\"string\\\" },\\n    \\\"flights\\\": {\\n      \\\"type\\\": \\\"array\\\",\\n      \\\"items\\\": {\\n        \\\"type\\\": \\\"object\\\",\\n        \\\"properties\\\": {\\n          \\\"from\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"to\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"date\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"flight_number\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"departure_time\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"departure_airport\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"arrival_time\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"arrival_airport\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"duration\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"seat_type\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"fare_type\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"baggage_allowance\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"meal_preference\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"e_ticket_no\\\": { \\\"type\\\": \\\"string\\\" },\\n          \\\"barcode\\\": { \\\"type\\\": \\\"string\\\" }\\n        }\\n      }\\n    }\\n}\\n}\""),

                                new ChatMessage(ChatMessageRole.User, "This is the email content, " + Email)
    }
            };

            var results = await api.Chat.CreateChatCompletionAsync(chatRequest);

            return StatusCode(200, results.ToString());
        }
        catch (Exception ex)
        {
            return StatusCode(500, $"Internal server error: {ex.Message}");
        }
    }
}


